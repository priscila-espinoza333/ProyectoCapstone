{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ cancha.nombre }} | {{ cancha.recinto.nombre }}{% endblock %}

{% block content %}
<!-- Leaflet CSS (se puede cargar dentro del body sin problema) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<div class="container py-5">

  <!-- Encabezado -->
  <div class="text-center mb-5">
    <h1 class="brand-title">
      <span class="brand-match">{{ cancha.recinto.nombre }}</span>
    </h1>
    <h2 class="section-heading">{{ cancha.nombre }}</h2>
    <p class="text-muted">{{ cancha.descripcion|default:"Cancha disponible para reservas" }}</p>
    <span class="badge badge-gold">{{ cancha.get_deporte_display }}</span>
    <span class="badge badge-purple">{{ cancha.tipo_superficie|default:"-" }}</span>
  </div>

  <div class="row g-4">
    <!-- Columna izquierda: info + reservas del d√≠a + mapa -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <img src="{% static 'core/img/canchafut.webp' %}" class="card-img-top" alt="Foto de {{ cancha.nombre }}">
        <div class="card-body">
          <h5 class="card-title">Detalles</h5>
          <ul class="list-unstyled cancha-info mb-0">
            <li><i class="bi bi-geo-alt"></i> {{ cancha.recinto.direccion }}</li>
            <li><i class="bi bi-clock"></i> {{ cancha.recinto.hora_apertura|time:"H:i" }} ‚Äì {{ cancha.recinto.hora_cierre|time:"H:i" }}</li>
            <li><i class="bi bi-cash"></i> ${{ cancha.precio_hora|floatformat:0 }} / hora</li>
          </ul>
        </div>
      </div>

      {% if cancha.latitud and cancha.longitud %}
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header card-header-gold">Ubicaci√≥n</div>
        <div class="card-body">
          <p class="mb-2">
            <strong>Direcci√≥n:</strong> {{ cancha.recinto.direccion }}
          </p>
          <div id="map" style="height: 350px; width: 100%; border-radius: 8px;"></div>
        </div>
      </div>
      {% else %}
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header card-header-gold">Ubicaci√≥n</div>
        <div class="card-body">
          <p class="mb-0"><em>Ubicaci√≥n en mapa no disponible. Falta latitud/longitud.</em></p>
        </div>
      </div>
      {% endif %}

      {% if reservas_del_dia %}
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header card-header-dark">Reservas del d√≠a</div>
        <ul class="list-group list-group-flush">
          {% for r in reservas_del_dia %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ r.fecha_hora_inicio|date:"H:i" }} ‚Äì {{ r.fecha_hora_fin|date:"H:i" }}</span>
            <span class="badge {% if r.estado == 'CONFIRMADA' %}bg-success{% elif r.estado == 'PENDIENTE' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
              {{ r.get_estado_display }}
            </span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    <!-- Columna derecha: fecha + selector de tramos -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-3">Reserva tu horario</h5>

          {# Selector de fecha (GET) SIN bot√≥n ‚Äî autosubmit al cambiar #}
          <form method="get" class="mb-3" id="form-fecha">
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label" for="fecha">Fecha</label>
                <input
                  type="date"
                  class="form-control"
                  name="fecha"
                  id="fecha"
                  value="{% if fecha_actual %}{{ fecha_actual|date:'Y-m-d' }}{% endif %}"
                  required
                >
                <small class="text-muted">Selecciona una fecha para ver disponibilidad.</small>
              </div>
            </div>
          </form>

          <!-- Tramos disponibles -->
          <div class="card shadow-sm border-0">
            <div class="card-header card-header-gold">Tramos disponibles</div>
            <div class="card-body">
              {% if fecha_actual and tramos %}
                <div id="grid-tramos" class="d-flex flex-wrap gap-2">
                  {% for t in tramos %}
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm tramo-btn"
                      data-inicio="{{ t.inicio|date:'c' }}"
                      data-fin="{{ t.fin|date:'c' }}"
                      data-precio="{{ t.precio }}"
                      data-label="{{ t.inicio|date:'H:i' }}‚Äì{{ t.fin|date:'H:i' }}"
                      aria-pressed="false"
                    >
                      {{ t.inicio|date:"H:i" }} ‚Äì {{ t.fin|date:"H:i" }}
                      {% if t.precio %}
                        <span class="ms-1 badge bg-light text-dark">
                          ${{ t.precio|floatformat:0 }}
                        </span>
                      {% endif %}
                    </button>
                  {% endfor %}
                </div>

                <!-- üöÄ FORMULARIO PARA A√ëADIR AL CARRITO -->
                <form method="post" action="{% url 'agregar_reserva' cancha.id %}" id="form-carrito" class="mt-3">
                  {% csrf_token %}
                  <input type="hidden" name="inicio" id="sel-inicio">
                  <input type="hidden" name="fin" id="sel-fin">

                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                      <div class="small text-muted">Selecci√≥n:</div>
                      <div id="sel-texto" class="fw-semibold">‚Äî</div>
                      <div id="sel-precio" class="text-muted small"></div>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-limpiar">Limpiar</button>
                      <button type="submit" class="btn btn-gold" id="btn-add" disabled>A√±adir al carrito</button>
                    </div>
                  </div>
                </form>
                <!-- üöÄ FIN FORMULARIO -->

                <small class="text-muted d-block mt-2">
                  Puedes seleccionar <strong>1</strong> tramo o <strong>2 consecutivos</strong>.
                </small>

              {% elif fecha_actual and not tramos %}
                <div class="alert alert-info mb-0">No hay tramos disponibles para la fecha seleccionada.</div>
              {% else %}
                <div class="text-muted">Selecciona una fecha para cargar los tramos.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const fecha = document.getElementById('fecha');
      const form  = document.getElementById('form-fecha');
      if (fecha) {
        // min = hoy
        const hoy = new Date();
        const pad = n => String(n).padStart(2,'0');
        fecha.min = `${hoy.getFullYear()}-${pad(hoy.getMonth()+1)}-${pad(hoy.getDate())}`;

        // auto-enviar al cambiar
        fecha.addEventListener('change', () => form && form.submit());
      }
    });
  </script>

  {% if cancha.latitud and cancha.longitud %}
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Convertir string ‚Üí n√∫mero JS con punto decimal
    var lat = parseFloat("{{ cancha.latitud }}".replace(",", "."));
    var lng = parseFloat("{{ cancha.longitud }}".replace(",", "."));

    var map = L.map("map").setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    L.marker([lat, lng])
      .addTo(map)
      .bindPopup("{{ cancha.nombre|escapejs }}")
      .openPopup();
  });
  </script>
  {% endif %}

  <script src="{% static 'core/js/cancha_detalle.js' %}"></script>
{% endblock %}
