{# core/templates/core/reservas/resumen.html #}
{% extends "core/base.html" %}
{% load static %}
{% block title %}Resumen de reserva{% endblock %}

{% block content %}
{# Leaflet CSS (igual que en cancha_detalle) #}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<div class="container py-5">

  <div class="text-center mb-4">
    <h1 class="brand-title">
      <span class="brand-match">RESUMEN</span> <span class="brand-play">RESERVA</span>
    </h1>
    <p class="text-muted m-0">Confirma los datos antes de finalizar.</p>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">Detalles</h5>

          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <span>Cancha</span>
              <strong>{{ reserva.cancha.nombre }} ({{ reserva.cancha.get_deporte_display }})</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Recinto</span>
              <strong>{{ reserva.cancha.recinto.nombre }}</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Fecha</span>
              <strong>{{ reserva.fecha_hora_inicio|date:"d/m/Y" }}</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Horario</span>
              <strong>{{ reserva.fecha_hora_inicio|time:"H:i" }} ‚Äì {{ reserva.fecha_hora_fin|time:"H:i" }}</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Total</span>
              <strong>${{ reserva.precio_total|floatformat:0 }}</strong>
            </li>
          </ul>

          {# üîπ MAPA: misma l√≥gica que en cancha_detalle, pero usando reserva.cancha #}
          {% if reserva.cancha.latitud and reserva.cancha.longitud %}
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header card-header-gold">Ubicaci√≥n</div>
            <div class="card-body">
              <p class="mb-2">
                <strong>Direcci√≥n:</strong> {{ reserva.cancha.recinto.direccion }}
              </p>
              <div id="map-resumen" style="height: 350px; width: 100%; border-radius: 8px;"></div>
            </div>
          </div>
          {% else %}
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header card-header-gold">Ubicaci√≥n</div>
            <div class="card-body">
              <p class="mb-0"><em>Ubicaci√≥n en mapa no disponible. Falta latitud/longitud.</em></p>
            </div>
          </div>
          {% endif %}

          <div class="d-flex gap-2 justify-content-end">
            <a class="btn btn-outline-secondary" href="{% url 'cancha_detalle' reserva.cancha.id %}">Volver</a>
            <form method="post" action="{% url 'reservas_confirmar' reserva_id=reserva.id %}">
              {% csrf_token %}
              {# bot√≥n de confirmar si lo quieres activar m√°s adelante #}
              {# <button type="submit" class="btn btn-primary">Confirmar reserva</button> #}
            </form>
            
          </div>
        </div>
      </div>

      <p class="text-center text-muted mt-3 mb-0 small">
        Al confirmar aceptas nuestras pol√≠ticas de uso y cancelaci√≥n.
      </p>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}

  {# Leaflet JS (igual que en cancha_detalle) #}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  {% if reserva.cancha.latitud and reserva.cancha.longitud %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Igual que en cancha_detalle, pero con reserva.cancha y otro id de mapa
      var lat = parseFloat("{{ reserva.cancha.latitud }}".replace(",", "."));
      var lng = parseFloat("{{ reserva.cancha.longitud }}".replace(",", "."));

      var map = L.map("map-resumen").setView([lat, lng], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      L.marker([lat, lng])
        .addTo(map)
        .bindPopup("{{ reserva.cancha.recinto.nombre|escapejs }}<br>{{ reserva.cancha.nombre|escapejs }}")
        .openPopup();
    });
  </script>
  {% endif %}
{% endblock %}
